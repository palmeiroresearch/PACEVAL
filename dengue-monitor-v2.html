<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Dengue - Signos de Alarma v2.0</title>
    <link rel="manifest" href="manifest-dengue.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="apple-touch-icon" href="icon-dengue-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: #991b1b;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #dc2626;
            color: white;
        }

        .btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: #991b1b;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #dc2626;
            border-bottom-color: #dc2626;
            background: white;
        }

        .content {
            padding: 20px;
            min-height: 500px;
        }

        .patient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .patient-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .patient-card:hover {
            border-color: #dc2626;
            box-shadow: 0 8px 16px rgba(220, 38, 38, 0.1);
            transform: translateY(-2px);
        }

        .patient-card.alert {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .patient-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .patient-id {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .alert-badge {
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .patient-info {
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
        }

        .info-label {
            color: #6b7280;
            font-weight: 500;
        }

        .info-value {
            color: #1f2937;
            font-weight: 600;
        }

        .last-check {
            color: #059669;
            font-size: 12px;
            margin-top: 10px;
        }

        .overdue {
            color: #dc2626;
        }

        .patient-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #1f2937;
            font-size: 24px;
        }

        .close-modal {
            background: #f3f4f6;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
        }

        .close-modal:hover {
            background: #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .calculated-field {
            background: #f0fdf4;
            border-color: #86efac;
            font-weight: 600;
            color: #166534;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            color: #374151;
        }

        .alert-count {
            background: #dc2626;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .monitoring-history {
            margin-top: 20px;
        }

        .history-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #dc2626;
            position: relative;
        }

        .history-time {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .history-signs {
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .history-notes {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }

        .history-edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .history-edit-btn:hover {
            background: #5a67d8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #dc2626;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #dc2626;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        .patient-detail-section {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .patient-detail-section h4 {
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #dc2626;
        }

        .detail-item-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item-value {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-top: 3px;
        }

        .vitals-section {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .vitals-section h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .time-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .time-badge.good {
            background: #d1fae5;
            color: #065f46;
        }

        .time-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .time-badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .patient-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #16a34a;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 10000;
        }

        .offline-indicator.offline {
            background: #dc2626;
            display: block;
        }

        .input-hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .edit-icon {
            cursor: pointer;
            color: #667eea;
            margin-left: 8px;
            font-size: 14px;
        }

        .edit-icon:hover {
            color: #5a67d8;
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        📱 Modo offline - Datos guardados localmente
    </div>

    <div class="container">
        <div class="header">
            <h1>
                🏥 Monitor Dengue v2.0
                <span class="alert-count" id="totalAlertsCount">0</span>
            </h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openNewPatientModal()">
                    ➕ Nuevo Paciente
                </button>
                <button class="btn btn-secondary" onclick="exportAllData()">
                    📥 Exportar
                </button>
                <button class="btn btn-secondary" onclick="showImportModal()">
                    📤 Importar
                </button>
                <button class="btn btn-danger" onclick="clearAllData()">
                    🗑️ Borrar Todo
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('patients')">
                👥 Pacientes Activos
            </div>
            <div class="tab" onclick="switchTab('stats')">
                📊 Estadísticas
            </div>
        </div>

        <div class="content">
            <!-- Tab: Pacientes Activos -->
            <div id="patientsTab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPatients">0</div>
                        <div class="stat-label">Pacientes en Monitoreo (Máx: 24)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="patientsWithAlerts">0</div>
                        <div class="stat-label">Con Signos de Alarma</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overdueChecks">0</div>
                        <div class="stat-label">Chequeos Vencidos</div>
                    </div>
                </div>

                <div class="patient-grid" id="patientGrid">
                    <!-- Pacientes se cargarán dinámicamente -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">🏥</div>
                    <h3>No hay pacientes en monitoreo</h3>
                    <p>Agrega el primer paciente para comenzar el seguimiento</p>
                </div>
            </div>

            <!-- Tab: Estadísticas -->
            <div id="statsTab" style="display: none;">
                <h2 style="margin-bottom: 20px;">Resumen de Signos de Alarma</h2>
                <div id="statsContent">
                    <!-- Estadísticas se cargarán dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo/Editar Paciente -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="patientModalTitle">Nuevo Paciente</h2>
                <button class="close-modal" onclick="closeModal('patientModal')">×</button>
            </div>
            <form id="patientForm" onsubmit="savePatient(event)">
                <input type="hidden" id="editPatientId" value="">
                
                <h3 style="color: #374151; margin-bottom: 15px;">Datos Personales</h3>
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="patientName" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Edad *</label>
                        <input type="number" id="patientAge" required min="0" max="120">
                    </div>
                    <div class="form-group">
                        <label>Sexo *</label>
                        <select id="patientSex" required>
                            <option value="">Seleccionar...</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Número de Cama/Historia</label>
                        <input type="text" id="patientBed">
                    </div>
                </div>

                <h3 style="color: #374151; margin: 20px 0 15px 0;">Antropometría</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Peso (kg) *</label>
                        <input type="number" id="patientWeight" required min="1" max="300" step="0.1" onchange="calculateMetrics()">
                    </div>
                    <div class="form-group">
                        <label>Talla (cm) *</label>
                        <input type="number" id="patientHeight" required min="30" max="250" step="0.1" onchange="calculateMetrics()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>IMC (kg/m²)</label>
                        <input type="number" id="patientIMC" class="calculated-field" readonly step="0.01">
                        <div class="input-hint">Calculado automáticamente</div>
                    </div>
                    <div class="form-group">
                        <label>Superficie Corporal (m²)</label>
                        <input type="number" id="patientSC" class="calculated-field" readonly step="0.01">
                        <div class="input-hint">Calculado automáticamente</div>
                    </div>
                </div>

                <h3 style="color: #374151; margin: 20px 0 15px 0;">Historia de la Enfermedad</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fecha Inicio Síntomas *</label>
                        <input type="date" id="symptomsDate" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha Inicio Fiebre *</label>
                        <input type="date" id="feverDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Signo de Alarma de Ingreso *</label>
                    <select id="admissionSign" required>
                        <option value="">Seleccionar...</option>
                        <option value="Dolor abdominal intenso y continuo">Dolor abdominal intenso y continuo</option>
                        <option value="Vómitos persistentes">Vómitos persistentes</option>
                        <option value="Acumulación de líquidos">Acumulación de líquidos (ascitis, derrame)</option>
                        <option value="Sangrado de mucosas">Sangrado de mucosas</option>
                        <option value="Letargia o irritabilidad">Letargia o irritabilidad</option>
                        <option value="Hepatomegalia >2cm">Hepatomegalia >2cm</option>
                        <option value="Aumento Hto / Caída plaquetas">Aumento del Hto con caída de plaquetas</option>
                        <option value="Hipotensión postural">Hipotensión postural (lipotimia)</option>
                        <option value="Otro">Otro / Ninguno específico</option>
                    </select>
                </div>

                <h3 style="color: #374151; margin: 20px 0 15px 0;">Monitoreo</h3>
                <div class="form-group">
                    <label>Intervalo de Monitoreo *</label>
                    <select id="monitoringInterval" required>
                        <option value="1">Cada 1 hora</option>
                        <option value="2">Cada 2 horas</option>
                        <option value="3">Cada 3 horas</option>
                        <option value="4">Cada 4 horas</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Observaciones Iniciales</label>
                    <textarea id="initialNotes" placeholder="Descripción del cuadro, comorbilidades, laboratorios de ingreso..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <span id="savePatientBtnText">Guardar Paciente</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Chequeo de Signos -->
    <div class="modal" id="checkSignsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="checkModalTitle">Chequeo de Signos de Alarma</h2>
                <button class="close-modal" onclick="closeModal('checkSignsModal')">×</button>
            </div>
            <div>
                <input type="hidden" id="editCheckIndex" value="">
                <h3 id="checkPatientName" style="color: #6b7280; margin-bottom: 20px;"></h3>
                
                <div class="vitals-section">
                    <h4>🩺 Signos Vitales</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Temperatura (°C)</label>
                            <input type="number" id="checkTemp" step="0.1" min="35" max="42" placeholder="37.0">
                        </div>
                        <div class="form-group">
                            <label>FC (lpm)</label>
                            <input type="number" id="checkHR" min="30" max="220" placeholder="80">
                        </div>
                        <div class="form-group">
                            <label>FR (rpm)</label>
                            <input type="number" id="checkRR" min="8" max="60" placeholder="18">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>TA Sistólica (mmHg)</label>
                            <input type="number" id="checkSBP" min="50" max="250" placeholder="120" onchange="calculatePAM()">
                        </div>
                        <div class="form-group">
                            <label>TA Diastólica (mmHg)</label>
                            <input type="number" id="checkDBP" min="30" max="150" placeholder="80" onchange="calculatePAM()">
                        </div>
                        <div class="form-group">
                            <label>PAM (mmHg)</label>
                            <input type="number" id="checkPAM" class="calculated-field" readonly>
                            <div class="input-hint">Calculada: (SBP + 2×DBP)/3</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>SatO₂ (%)</label>
                            <input type="number" id="checkSatO2" min="50" max="100" placeholder="98">
                        </div>
                        <div class="form-group">
                            <label>Hidratación (ml/kg/h)</label>
                            <input type="number" id="checkHydration" step="0.1" min="0" max="50" placeholder="5.0">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Signos de Alarma Detectados</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign1" value="Dolor abdominal intenso y continuo">
                            <label for="sign1">Dolor abdominal intenso y continuo</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign2" value="Vómitos persistentes">
                            <label for="sign2">Vómitos persistentes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign3" value="Acumulación de líquidos (ascitis, derrame pleural/pericárdico)">
                            <label for="sign3">Acumulación de líquidos (ascitis, derrame pleural/pericárdico)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign4" value="Sangrado de mucosas">
                            <label for="sign4">Sangrado de mucosas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign5" value="Letargia o irritabilidad">
                            <label for="sign5">Letargia o irritabilidad</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign6" value="Hepatomegalia >2cm">
                            <label for="sign6">Hepatomegalia >2cm</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign7" value="Aumento del Hto con caída de plaquetas">
                            <label for="sign7">Aumento del Hto con caída de plaquetas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign8" value="Hipotensión postural (lipotimia)">
                            <label for="sign8">Hipotensión postural (lipotimia)</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notas y Observaciones</label>
                    <textarea id="checkNotes" placeholder="Evolución clínica, laboratorios, conducta..."></textarea>
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="saveCheck()">
                    <span id="saveCheckBtnText">Guardar Chequeo</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Ficha Completa del Paciente -->
    <div class="modal" id="patientFileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 Ficha Completa del Paciente</h2>
                <button class="close-modal" onclick="closeModal('patientFileModal')">×</button>
            </div>
            <div id="patientFileContent">
                <!-- Contenido se cargará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal: Historia del Paciente -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historia del Paciente</h2>
                <button class="close-modal" onclick="closeModal('historyModal')">×</button>
            </div>
            <div>
                <h3 id="historyPatientName" style="color: #6b7280; margin-bottom: 20px;"></h3>
                <div id="historyContent" class="monitoring-history">
                    <!-- Historia se cargará dinámicamente -->
                </div>
                <button class="btn btn-success" style="width: 100%; margin-top: 20px;" onclick="generateReport()">
                    📄 Generar Informe Completo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Importar Datos -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📤 Importar Datos</h2>
                <button class="close-modal" onclick="closeModal('importModal')">×</button>
            </div>
            <div>
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #fbbf24;">
                    <strong>⚠️ Advertencia:</strong> Importar datos reemplazará TODOS los datos actuales. Asegúrate de hacer una copia de seguridad primero.
                </div>
                
                <div class="form-group">
                    <label>Seleccionar archivo JSON de respaldo</label>
                    <input type="file" id="importFile" accept=".json" style="padding: 10px; border: 2px dashed #dc2626;">
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="importData()">
                    Importar Datos
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let patients = [];
        let currentPatientId = null;

        // Inicializar la aplicación
        function init() {
            loadPatients();
            renderPatients();
            updateStats();
            setInterval(checkOverduePatients, 60000);
            updateConnectionStatus();
        }

        // Cargar pacientes del localStorage (SIN límite de 48h)
        function loadPatients() {
            const stored = localStorage.getItem('dengue_patients');
            if (stored) {
                patients = JSON.parse(stored);
            }
        }

        // Guardar pacientes en localStorage
        function savePatients() {
            localStorage.setItem('dengue_patients', JSON.stringify(patients));
        }

        // Calcular métricas antropométricas
        function calculateMetrics() {
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const heightCm = parseFloat(document.getElementById('patientHeight').value);
            
            if (weight && heightCm) {
                const heightM = heightCm / 100;
                
                // IMC = peso(kg) / talla(m)²
                const imc = weight / (heightM * heightM);
                document.getElementById('patientIMC').value = imc.toFixed(2);
                
                // Superficie Corporal (Mosteller): SC = √(altura(cm) × peso(kg) / 3600)
                const sc = Math.sqrt((heightCm * weight) / 3600);
                document.getElementById('patientSC').value = sc.toFixed(2);
            }
        }

        // Calcular PAM
        function calculatePAM() {
            const sbp = parseFloat(document.getElementById('checkSBP').value);
            const dbp = parseFloat(document.getElementById('checkDBP').value);
            
            if (sbp && dbp) {
                // PAM = (SBP + 2×DBP) / 3
                const pam = (sbp + 2 * dbp) / 3;
                document.getElementById('checkPAM').value = pam.toFixed(0);
            }
        }

        // Cambiar de tab
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('patientsTab').style.display = tab === 'patients' ? 'block' : 'none';
            document.getElementById('statsTab').style.display = tab === 'stats' ? 'block' : 'none';

            if (tab === 'stats') {
                renderStats();
            }
        }

        // Abrir modal de nuevo paciente
        function openNewPatientModal() {
            if (patients.length >= 24) {
                alert('⚠️ Has alcanzado el límite de 24 pacientes. Elimina alguno para agregar más.');
                return;
            }
            
            document.getElementById('patientModalTitle').textContent = 'Nuevo Paciente';
            document.getElementById('savePatientBtnText').textContent = 'Guardar Paciente';
            document.getElementById('editPatientId').value = '';
            document.getElementById('patientForm').reset();
            
            // Establecer fechas por defecto (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('symptomsDate').value = today;
            document.getElementById('feverDate').value = today;
            
            document.getElementById('patientModal').classList.add('show');
        }

        // Abrir modal para editar paciente
        function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            // 🔧 FIX: Cerrar modal de ficha antes de abrir el de edición
            closeModal('patientFileModal');

            document.getElementById('patientModalTitle').textContent = 'Editar Paciente';
            document.getElementById('savePatientBtnText').textContent = 'Actualizar Paciente';
            document.getElementById('editPatientId').value = patientId;

            // Llenar formulario con datos del paciente
            document.getElementById('patientName').value = patient.name;
            document.getElementById('patientAge').value = patient.age;
            document.getElementById('patientSex').value = patient.sex;
            document.getElementById('patientBed').value = patient.bed || '';
            document.getElementById('patientWeight').value = patient.weight;
            document.getElementById('patientHeight').value = patient.height;
            document.getElementById('symptomsDate').value = patient.symptomsDate;
            document.getElementById('feverDate').value = patient.feverDate;
            document.getElementById('admissionSign').value = patient.admissionSign;
            document.getElementById('monitoringInterval').value = patient.monitoringInterval;
            document.getElementById('initialNotes').value = patient.initialNotes || '';

            calculateMetrics();
            
            document.getElementById('patientModal').classList.add('show');
        }

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Guardar paciente (nuevo o editado)
        function savePatient(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editPatientId').value;
            const patientData = {
                name: document.getElementById('patientName').value,
                age: document.getElementById('patientAge').value,
                sex: document.getElementById('patientSex').value,
                bed: document.getElementById('patientBed').value || 'N/A',
                weight: parseFloat(document.getElementById('patientWeight').value),
                height: parseFloat(document.getElementById('patientHeight').value),
                imc: parseFloat(document.getElementById('patientIMC').value),
                sc: parseFloat(document.getElementById('patientSC').value),
                symptomsDate: document.getElementById('symptomsDate').value,
                feverDate: document.getElementById('feverDate').value,
                admissionSign: document.getElementById('admissionSign').value,
                monitoringInterval: parseInt(document.getElementById('monitoringInterval').value),
                initialNotes: document.getElementById('initialNotes').value
            };

            let savedPatientId;

            if (editId) {
                // Actualizar paciente existente
                const patient = patients.find(p => p.id === editId);
                if (patient) {
                    Object.assign(patient, patientData);
                    savedPatientId = editId;
                }
            } else {
                // Crear nuevo paciente
                const newPatient = {
                    ...patientData,
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    lastCheck: null,
                    checks: [],
                    hasAlerts: false
                };
                patients.push(newPatient);
                savedPatientId = newPatient.id;
            }

            savePatients();
            renderPatients();
            updateStats();
            
            document.getElementById('patientForm').reset();
            closeModal('patientModal');
            
            // 🔧 FIX: Abrir la ficha del paciente después de guardar
            if (savedPatientId) {
                viewPatientFile(savedPatientId);
            }
        }

        // Ver ficha completa del paciente
        function viewPatientFile(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            const daysOfSymptoms = Math.floor((new Date() - new Date(patient.symptomsDate)) / (1000 * 60 * 60 * 24));
            const daysOfFever = Math.floor((new Date() - new Date(patient.feverDate)) / (1000 * 60 * 60 * 24));

            const content = `
                <div class="patient-detail-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1f2937; margin: 0;">${patient.name}</h3>
                        <button class="btn btn-secondary btn-small" onclick="editPatient('${patient.id}')">
                            ✏️ Editar Ficha
                        </button>
                    </div>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-item-label">Edad</div>
                            <div class="detail-item-value">${patient.age} años</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Sexo</div>
                            <div class="detail-item-value">${patient.sex === 'M' ? 'Masculino' : 'Femenino'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Cama/Historia</div>
                            <div class="detail-item-value">${patient.bed}</div>
                        </div>
                    </div>
                </div>

                <div class="patient-detail-section">
                    <h4>📏 Antropometría</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-item-label">Peso</div>
                            <div class="detail-item-value">${patient.weight} kg</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Talla</div>
                            <div class="detail-item-value">${patient.height} cm</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">IMC</div>
                            <div class="detail-item-value">${patient.imc.toFixed(2)} kg/m²</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Sup. Corporal</div>
                            <div class="detail-item-value">${patient.sc.toFixed(2)} m²</div>
                        </div>
                    </div>
                </div>

                <div class="patient-detail-section">
                    <h4>🦠 Historia de Enfermedad</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-item-label">Inicio Síntomas</div>
                            <div class="detail-item-value">${new Date(patient.symptomsDate).toLocaleDateString('es-ES')} (Día ${daysOfSymptoms})</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Inicio Fiebre</div>
                            <div class="detail-item-value">${new Date(patient.feverDate).toLocaleDateString('es-ES')} (Día ${daysOfFever})</div>
                        </div>
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-item-label">Signo de Alarma de Ingreso</div>
                            <div class="detail-item-value" style="font-size: 14px;">${patient.admissionSign}</div>
                        </div>
                    </div>
                </div>

                <div class="patient-detail-section">
                    <h4>📝 Observaciones Iniciales</h4>
                    <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #dc2626;">
                        ${patient.initialNotes || '<em style="color: #9ca3af;">Sin observaciones registradas</em>'}
                    </div>
                </div>

                <div class="patient-detail-section">
                    <h4>⏱️ Monitoreo</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-item-label">Intervalo</div>
                            <div class="detail-item-value">Cada ${patient.monitoringInterval}h</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Chequeos Realizados</div>
                            <div class="detail-item-value">${patient.checks.length}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-item-label">Fecha Ingreso</div>
                            <div class="detail-item-value">${new Date(patient.createdAt).toLocaleDateString('es-ES')}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('patientFileContent').innerHTML = content;
            document.getElementById('patientFileModal').classList.add('show');
        }

        // Renderizar lista de pacientes
        function renderPatients() {
            const grid = document.getElementById('patientGrid');
            const emptyState = document.getElementById('emptyState');

            if (patients.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = patients.map(p => {
                const timeSinceCheck = getTimeSinceLastCheck(p);
                const isOverdue = timeSinceCheck.isOverdue;
                const timeBadge = getTimeBadge(timeSinceCheck.hours, p.monitoringInterval);
                const daysOfSymptoms = Math.floor((new Date() - new Date(p.symptomsDate)) / (1000 * 60 * 60 * 24));

                return `
                    <div class="patient-card ${p.hasAlerts ? 'alert' : ''}">
                        <div class="patient-header">
                            <div>
                                <div class="patient-name">${p.name}</div>
                                <div class="patient-id">Cama: ${p.bed} | Día ${daysOfSymptoms} de síntomas</div>
                            </div>
                            ${p.hasAlerts ? '<span class="alert-badge">⚠️ ALERTA</span>' : ''}
                        </div>
                        
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">Edad/Sexo:</span>
                                <span class="info-value">${p.age}a / ${p.sex === 'M' ? 'M' : 'F'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Peso/Talla:</span>
                                <span class="info-value">${p.weight}kg / ${p.height}cm</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">IMC:</span>
                                <span class="info-value">${p.imc.toFixed(1)} kg/m²</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Monitoreo:</span>
                                <span class="info-value">Cada ${p.monitoringInterval}h</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Chequeos:</span>
                                <span class="info-value">${p.checks.length}</span>
                            </div>
                        </div>

                        <div class="last-check ${isOverdue ? 'overdue' : ''}">
                            ${p.lastCheck 
                                ? `⏱️ Último chequeo: ${timeSinceCheck.text} ${timeBadge}`
                                : '⚠️ Sin chequeos registrados'}
                        </div>

                        <div class="patient-actions">
                            <button class="btn btn-primary btn-small" onclick="openCheckModal('${p.id}')">
                                ✅ Chequear
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="viewPatientFile('${p.id}')">
                                📋 Ficha
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="viewHistory('${p.id}')">
                                📊 Historia
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deletePatient('${p.id}')">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obtener tiempo desde el último chequeo
        function getTimeSinceLastCheck(patient) {
            if (!patient.lastCheck) {
                return { text: 'Nunca', hours: 999, isOverdue: true };
            }

            const now = new Date();
            const lastCheck = new Date(patient.lastCheck);
            const diffMs = now - lastCheck;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            const isOverdue = diffHours >= patient.monitoringInterval;

            let text;
            if (diffHours === 0) {
                text = `hace ${diffMins} min`;
            } else {
                text = `hace ${diffHours}h ${diffMins}min`;
            }

            return { text, hours: diffHours, isOverdue };
        }

        // Obtener badge de tiempo
        function getTimeBadge(hours, interval) {
            if (hours < interval * 0.8) {
                return '<span class="time-badge good">✓ Al día</span>';
            } else if (hours < interval) {
                return '<span class="time-badge warning">⚠ Próximo</span>';
            } else {
                return '<span class="time-badge danger">⚠ Vencido</span>';
            }
        }

        // Abrir modal de chequeo
        function openCheckModal(patientId, checkIndex = null) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            if (checkIndex !== null) {
                // 🔧 FIX: Cerrar modal de historia antes de abrir el de edición
                closeModal('historyModal');
                
                // Editar chequeo existente
                const check = patient.checks[checkIndex];
                document.getElementById('checkModalTitle').textContent = 'Editar Chequeo';
                document.getElementById('saveCheckBtnText').textContent = 'Actualizar Chequeo';
                document.getElementById('editCheckIndex').value = checkIndex;

                // Llenar signos vitales
                document.getElementById('checkTemp').value = check.vitals?.temp || '';
                document.getElementById('checkHR').value = check.vitals?.hr || '';
                document.getElementById('checkRR').value = check.vitals?.rr || '';
                document.getElementById('checkSBP').value = check.vitals?.sbp || '';
                document.getElementById('checkDBP').value = check.vitals?.dbp || '';
                document.getElementById('checkPAM').value = check.vitals?.pam || '';
                document.getElementById('checkSatO2').value = check.vitals?.sato2 || '';
                document.getElementById('checkHydration').value = check.vitals?.hydration || '';

                // Marcar signos de alarma
                for (let i = 1; i <= 8; i++) {
                    const checkbox = document.getElementById(`sign${i}`);
                    checkbox.checked = check.signs.includes(checkbox.value);
                }

                document.getElementById('checkNotes').value = check.notes || '';
            } else {
                // Nuevo chequeo
                document.getElementById('checkModalTitle').textContent = 'Chequeo de Signos de Alarma';
                document.getElementById('saveCheckBtnText').textContent = 'Guardar Chequeo';
                document.getElementById('editCheckIndex').value = '';
                
                // Limpiar formulario
                document.getElementById('checkTemp').value = '';
                document.getElementById('checkHR').value = '';
                document.getElementById('checkRR').value = '';
                document.getElementById('checkSBP').value = '';
                document.getElementById('checkDBP').value = '';
                document.getElementById('checkPAM').value = '';
                document.getElementById('checkSatO2').value = '';
                document.getElementById('checkHydration').value = '';

                for (let i = 1; i <= 8; i++) {
                    document.getElementById(`sign${i}`).checked = false;
                }
                document.getElementById('checkNotes').value = '';
            }
            
            document.getElementById('checkPatientName').textContent = `${patient.name} - ${patient.bed}`;
            document.getElementById('checkSignsModal').classList.add('show');
        }

        // Guardar chequeo (nuevo o editado)
        function saveCheck() {
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;

            const editIndex = document.getElementById('editCheckIndex').value;

            // Recopilar signos vitales
            const vitals = {
                temp: document.getElementById('checkTemp').value,
                hr: document.getElementById('checkHR').value,
                rr: document.getElementById('checkRR').value,
                sbp: document.getElementById('checkSBP').value,
                dbp: document.getElementById('checkDBP').value,
                pam: document.getElementById('checkPAM').value,
                sato2: document.getElementById('checkSatO2').value,
                hydration: document.getElementById('checkHydration').value
            };

            // Recopilar signos de alarma
            const signs = [];
            for (let i = 1; i <= 8; i++) {
                const checkbox = document.getElementById(`sign${i}`);
                if (checkbox.checked) {
                    signs.push(checkbox.value);
                }
            }

            const notes = document.getElementById('checkNotes').value;

            const checkData = {
                timestamp: new Date().toISOString(),
                vitals: vitals,
                signs: signs,
                notes: notes,
                hasAlerts: signs.length > 0
            };

            if (editIndex !== '') {
                // Actualizar chequeo existente
                patient.checks[parseInt(editIndex)] = checkData;
            } else {
                // Agregar nuevo chequeo
                patient.checks.push(checkData);
            }

            patient.lastCheck = checkData.timestamp;
            patient.hasAlerts = signs.length > 0;

            savePatients();
            renderPatients();
            updateStats();
            closeModal('checkSignsModal');
        }

        // Ver historia del paciente
        function viewHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            currentPatientId = patientId;
            document.getElementById('historyPatientName').textContent = `${patient.name} - ${patient.bed}`;

            const historyContent = document.getElementById('historyContent');
            
            if (patient.checks.length === 0) {
                historyContent.innerHTML = '<p style="text-align: center; color: #9ca3af;">No hay chequeos registrados</p>';
            } else {
                historyContent.innerHTML = patient.checks
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map((check, index) => {
                        const date = new Date(check.timestamp);
                        const originalIndex = patient.checks.indexOf(check);
                        
                        // Formatear signos vitales
                        let vitalsText = '';
                        if (check.vitals) {
                            const v = check.vitals;
                            vitalsText = '<div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin-top: 8px; font-size: 13px;">';
                            vitalsText += '<strong>Signos Vitales:</strong> ';
                            const vitalsArray = [];
                            if (v.temp) vitalsArray.push(`Tax: ${v.temp}°C`);
                            if (v.hr) vitalsArray.push(`FC: ${v.hr}lpm`);
                            if (v.rr) vitalsArray.push(`FR: ${v.rr}rpm`);
                            if (v.sbp && v.dbp) vitalsArray.push(`TA: ${v.sbp}/${v.dbp}`);
                            if (v.pam) vitalsArray.push(`PAM: ${v.pam}`);
                            if (v.sato2) vitalsArray.push(`SatO₂: ${v.sato2}%`);
                            if (v.hydration) vitalsArray.push(`Hidrat: ${v.hydration}ml/kg/h`);
                            vitalsText += vitalsArray.join(' | ');
                            vitalsText += '</div>';
                        }
                        
                        return `
                            <div class="history-item">
                                <button class="history-edit-btn" onclick="openCheckModal('${patientId}', ${originalIndex})">✏️ Editar</button>
                                <div class="history-time">
                                    📅 ${date.toLocaleDateString('es-ES')} - 
                                    🕐 ${date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                ${vitalsText}
                                ${check.signs.length > 0 ? `
                                    <div class="history-signs" style="margin-top: 8px;">
                                        <strong>⚠️ Signos de alarma:</strong><br>
                                        ${check.signs.map(s => `• ${s}`).join('<br>')}
                                    </div>
                                ` : '<div class="history-signs" style="margin-top: 8px;">✅ Sin signos de alarma</div>'}
                                ${check.notes ? `
                                    <div class="history-notes" style="margin-top: 8px;">
                                        📝 ${check.notes}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
            }

            document.getElementById('historyModal').classList.add('show');
        }

        // Generar informe del paciente
        function generateReport() {
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;

            const daysOfSymptoms = Math.floor((new Date() - new Date(patient.symptomsDate)) / (1000 * 60 * 60 * 24));
            const daysOfFever = Math.floor((new Date() - new Date(patient.feverDate)) / (1000 * 60 * 60 * 24));

            let report = `INFORME DE MONITOREO - DENGUE CON SIGNOS DE ALARMA\n`;
            report += `=================================================\n\n`;
            report += `DATOS DEL PACIENTE:\n`;
            report += `Nombre: ${patient.name}\n`;
            report += `Edad: ${patient.age} años | Sexo: ${patient.sex === 'M' ? 'Masculino' : 'Femenino'}\n`;
            report += `Cama/Historia: ${patient.bed}\n\n`;
            
            report += `ANTROPOMETRÍA:\n`;
            report += `Peso: ${patient.weight} kg | Talla: ${patient.height} cm\n`;
            report += `IMC: ${patient.imc.toFixed(2)} kg/m² | Superficie Corporal: ${patient.sc.toFixed(2)} m²\n\n`;
            
            report += `HISTORIA DE ENFERMEDAD ACTUAL:\n`;
            report += `Inicio de síntomas: ${new Date(patient.symptomsDate).toLocaleDateString('es-ES')} (Día ${daysOfSymptoms})\n`;
            report += `Inicio de fiebre: ${new Date(patient.feverDate).toLocaleDateString('es-ES')} (Día ${daysOfFever})\n`;
            report += `Signo de alarma de ingreso: ${patient.admissionSign}\n\n`;
            
            report += `OBSERVACIONES INICIALES:\n${patient.initialNotes || 'Sin observaciones'}\n\n`;

            report += `MONITOREO:\n`;
            report += `Intervalo: Cada ${patient.monitoringInterval} hora(s)\n`;
            report += `Fecha de ingreso: ${new Date(patient.createdAt).toLocaleString('es-ES')}\n\n`;

            report += `REGISTRO DE CHEQUEOS (${patient.checks.length} total):\n`;
            report += `-----------------------------------\n\n`;

            patient.checks.forEach((check, index) => {
                const date = new Date(check.timestamp);
                report += `[${index + 1}] ${date.toLocaleString('es-ES')}\n`;
                
                if (check.vitals) {
                    const v = check.vitals;
                    report += `Signos Vitales:\n`;
                    if (v.temp) report += `  • Temperatura: ${v.temp}°C\n`;
                    if (v.hr) report += `  • FC: ${v.hr} lpm\n`;
                    if (v.rr) report += `  • FR: ${v.rr} rpm\n`;
                    if (v.sbp && v.dbp) report += `  • TA: ${v.sbp}/${v.dbp} mmHg`;
                    if (v.pam) report += ` (PAM: ${v.pam})\n`; else report += `\n`;
                    if (v.sato2) report += `  • SatO₂: ${v.sato2}%\n`;
                    if (v.hydration) report += `  • Hidratación: ${v.hydration} ml/kg/h\n`;
                }
                
                if (check.signs.length > 0) {
                    report += `⚠️ SIGNOS DE ALARMA DETECTADOS:\n`;
                    check.signs.forEach(sign => {
                        report += `  • ${sign}\n`;
                    });
                } else {
                    report += `✅ Sin signos de alarma\n`;
                }
                
                if (check.notes) {
                    report += `📝 Notas: ${check.notes}\n`;
                }
                report += `\n`;
            });

            // Resumen
            const allSigns = patient.checks.flatMap(c => c.signs);
            const signCounts = {};
            allSigns.forEach(sign => {
                signCounts[sign] = (signCounts[sign] || 0) + 1;
            });

            if (Object.keys(signCounts).length > 0) {
                report += `\nRESUMEN DE SIGNOS DE ALARMA:\n`;
                report += `-----------------------------------\n`;
                Object.entries(signCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([sign, count]) => {
                        report += `• ${sign}: ${count} vez/veces\n`;
                    });
            }

            report += `\n\nInforme generado: ${new Date().toLocaleString('es-ES')}\n`;

            // Descargar
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Informe_${patient.name.replace(/\s/g, '_')}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Eliminar paciente
        function deletePatient(patientId) {
            if (!confirm('¿Está seguro de eliminar este paciente? Esta acción no se puede deshacer.')) {
                return;
            }

            patients = patients.filter(p => p.id !== patientId);
            savePatients();
            renderPatients();
            updateStats();
        }

        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const withAlerts = patients.filter(p => p.hasAlerts).length;
            document.getElementById('patientsWithAlerts').textContent = withAlerts;
            document.getElementById('totalAlertsCount').textContent = withAlerts;

            const overdue = patients.filter(p => {
                const time = getTimeSinceLastCheck(p);
                return time.isOverdue;
            }).length;
            document.getElementById('overdueChecks').textContent = overdue;
        }

        // Renderizar estadísticas detalladas
        function renderStats() {
            const statsContent = document.getElementById('statsContent');
            
            const allSigns = patients.flatMap(p => p.checks.flatMap(c => c.signs));
            const signCounts = {};
            
            allSigns.forEach(sign => {
                signCounts[sign] = (signCounts[sign] || 0) + 1;
            });

            if (Object.keys(signCounts).length === 0) {
                statsContent.innerHTML = '<p style="text-align: center; color: #9ca3af;">No hay datos suficientes para mostrar estadísticas</p>';
                return;
            }

            const sorted = Object.entries(signCounts).sort((a, b) => b[1] - a[1]);
            const maxCount = sorted[0][1];

            statsContent.innerHTML = `
                <div class="stats-grid">
                    ${sorted.map(([sign, count]) => {
                        const percentage = (count / maxCount) * 100;
                        return `
                            <div class="stat-card">
                                <div class="stat-value">${count}</div>
                                <div class="stat-label">${sign}</div>
                                <div style="margin-top: 10px; height: 8px; background: #fee2e2; border-radius: 4px;">
                                    <div style="width: ${percentage}%; height: 100%; background: #dc2626; border-radius: 4px;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Verificar chequeos vencidos
        function checkOverduePatients() {
            renderPatients();
            updateStats();
        }

        // Exportar todos los datos
        function exportAllData() {
            const data = {
                version: '2.0',
                exportDate: new Date().toISOString(),
                totalPatients: patients.length,
                patients: patients
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dengue_Monitor_Export_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('✅ Datos exportados exitosamente');
        }

        // Mostrar modal de importación
        function showImportModal() {
            document.getElementById('importModal').classList.add('show');
        }

        // Importar datos
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Por favor selecciona un archivo');
                return;
            }

            if (!confirm('⚠️ ADVERTENCIA: Esto reemplazará TODOS los datos actuales. ¿Continuar?')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validar estructura
                    if (!importedData.patients || !Array.isArray(importedData.patients)) {
                        throw new Error('Formato de archivo inválido');
                    }

                    // Reemplazar datos
                    patients = importedData.patients;
                    savePatients();
                    renderPatients();
                    updateStats();

                    closeModal('importModal');
                    alert(`✅ Datos importados exitosamente\n${patients.length} paciente(s) restaurados`);
                } catch (error) {
                    alert(`❌ Error al importar datos:\n${error.message}`);
                }
            };

            reader.readAsText(file);
        }

        // Borrar todos los datos
        function clearAllData() {
            if (!confirm('⚠️ ¿Estás SEGURO de que quieres BORRAR TODOS LOS DATOS?\n\nEsta acción NO se puede deshacer.')) {
                return;
            }

            if (!confirm('🚨 ÚLTIMA CONFIRMACIÓN:\n\nSe eliminarán todos los pacientes y sus chequeos.\n\n¿Continuar?')) {
                return;
            }

            patients = [];
            savePatients();
            renderPatients();
            updateStats();
            alert('✅ Todos los datos han sido borrados');
        }

        // Actualizar estado de conexión
        function updateConnectionStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                indicator.classList.add('offline');
            } else {
                indicator.classList.remove('offline');
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Iniciar la aplicación
        window.addEventListener('DOMContentLoaded', init);

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker-dengue.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Error:', err));
            });
        }
    </script>
</body>
</html>
