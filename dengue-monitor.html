<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Dengue - Signos de Alarma</title>
    <link rel="manifest" href="manifest-dengue.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="apple-touch-icon" href="icon-dengue-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: #991b1b;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #dc2626;
            color: white;
        }

        .btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            color: #991b1b;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .tabs {
            display: flex;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #dc2626;
            border-bottom-color: #dc2626;
            background: white;
        }

        .content {
            padding: 20px;
            min-height: 500px;
        }

        .patient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .patient-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .patient-card:hover {
            border-color: #dc2626;
            box-shadow: 0 8px 16px rgba(220, 38, 38, 0.1);
            transform: translateY(-2px);
        }

        .patient-card.alert {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .patient-name {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .patient-id {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .alert-badge {
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .patient-info {
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .info-label {
            color: #6b7280;
            font-weight: 500;
        }

        .info-value {
            color: #1f2937;
            font-weight: 600;
        }

        .last-check {
            color: #059669;
            font-size: 12px;
            margin-top: 10px;
        }

        .overdue {
            color: #dc2626;
        }

        .patient-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #1f2937;
            font-size: 24px;
        }

        .close-modal {
            background: #f3f4f6;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
        }

        .close-modal:hover {
            background: #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            border-color: #dc2626;
            background: #fef2f2;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            color: #374151;
        }

        .alert-count {
            background: #dc2626;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .monitoring-history {
            margin-top: 20px;
        }

        .history-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #dc2626;
        }

        .history-time {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .history-signs {
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .history-notes {
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #dc2626;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #dc2626;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .patient-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #16a34a;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 10000;
        }

        .offline-indicator.offline {
            background: #dc2626;
            display: block;
        }

        .time-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .time-badge.good {
            background: #d1fae5;
            color: #065f46;
        }

        .time-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .time-badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="offline-indicator" id="offlineIndicator">
        📱 Modo offline - Datos guardados localmente
    </div>

    <div class="container">
        <div class="header">
            <h1>
                🏥 Monitor Dengue
                <span class="alert-count" id="totalAlertsCount">0</span>
            </h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openNewPatientModal()">
                    ➕ Nuevo Paciente
                </button>
                <button class="btn btn-secondary" onclick="exportAllData()">
                    📥 Exportar
                </button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('patients')">
                👥 Pacientes Activos
            </div>
            <div class="tab" onclick="switchTab('stats')">
                📊 Estadísticas
            </div>
        </div>

        <div class="content">
            <!-- Tab: Pacientes Activos -->
            <div id="patientsTab">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPatients">0</div>
                        <div class="stat-label">Pacientes en Monitoreo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="patientsWithAlerts">0</div>
                        <div class="stat-label">Con Signos de Alarma</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="overdueChecks">0</div>
                        <div class="stat-label">Chequeos Vencidos</div>
                    </div>
                </div>

                <div class="patient-grid" id="patientGrid">
                    <!-- Pacientes se cargarán dinámicamente -->
                </div>

                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-state-icon">🏥</div>
                    <h3>No hay pacientes en monitoreo</h3>
                    <p>Agrega el primer paciente para comenzar el seguimiento</p>
                </div>
            </div>

            <!-- Tab: Estadísticas -->
            <div id="statsTab" style="display: none;">
                <h2 style="margin-bottom: 20px;">Resumen de Signos de Alarma</h2>
                <div id="statsContent">
                    <!-- Estadísticas se cargarán dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo Paciente -->
    <div class="modal" id="newPatientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuevo Paciente</h2>
                <button class="close-modal" onclick="closeModal('newPatientModal')">×</button>
            </div>
            <form id="newPatientForm" onsubmit="saveNewPatient(event)">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" id="patientName" required>
                </div>
                <div class="form-group">
                    <label>Edad *</label>
                    <input type="number" id="patientAge" required min="0" max="120">
                </div>
                <div class="form-group">
                    <label>Sexo *</label>
                    <select id="patientSex" required>
                        <option value="">Seleccionar...</option>
                        <option value="M">Masculino</option>
                        <option value="F">Femenino</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Número de Cama/Historia</label>
                    <input type="text" id="patientBed">
                </div>
                <div class="form-group">
                    <label>Intervalo de Monitoreo *</label>
                    <select id="monitoringInterval" required>
                        <option value="1">Cada 1 hora</option>
                        <option value="2">Cada 2 horas</option>
                        <option value="3">Cada 3 horas</option>
                        <option value="4">Cada 4 horas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones Iniciales</label>
                    <textarea id="initialNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Guardar Paciente
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Chequeo de Signos -->
    <div class="modal" id="checkSignsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chequeo de Signos de Alarma</h2>
                <button class="close-modal" onclick="closeModal('checkSignsModal')">×</button>
            </div>
            <div>
                <h3 id="checkPatientName" style="color: #6b7280; margin-bottom: 20px;"></h3>
                
                <div class="form-group">
                    <label>Signos de Alarma Detectados</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign1" value="Dolor abdominal intenso y continuo">
                            <label for="sign1">Dolor abdominal intenso y continuo</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign2" value="Vómitos persistentes">
                            <label for="sign2">Vómitos persistentes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign3" value="Acumulación de líquidos (ascitis, derrame pleural/pericárdico)">
                            <label for="sign3">Acumulación de líquidos (ascitis, derrame pleural/pericárdico)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign4" value="Sangrado de mucosas">
                            <label for="sign4">Sangrado de mucosas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign5" value="Letargia o irritabilidad">
                            <label for="sign5">Letargia o irritabilidad</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign6" value="Hepatomegalia >2cm">
                            <label for="sign6">Hepatomegalia >2cm</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign7" value="Aumento del Hto con caída de plaquetas">
                            <label for="sign7">Aumento del Hto con caída de plaquetas</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sign8" value="Hipotensión postural (lipotimia)">
                            <label for="sign8">Hipotensión postural (lipotimia)</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notas y Observaciones</label>
                    <textarea id="checkNotes" placeholder="Agregar detalles del chequeo..."></textarea>
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="saveCheck()">
                    Guardar Chequeo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Historia del Paciente -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historia del Paciente</h2>
                <button class="close-modal" onclick="closeModal('historyModal')">×</button>
            </div>
            <div>
                <h3 id="historyPatientName" style="color: #6b7280; margin-bottom: 20px;"></h3>
                <div id="historyContent" class="monitoring-history">
                    <!-- Historia se cargará dinámicamente -->
                </div>
                <button class="btn btn-success" style="width: 100%; margin-top: 20px;" onclick="generateReport()">
                    📄 Generar Informe Completo
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let patients = [];
        let currentPatientId = null;

        // Inicializar la aplicación
        function init() {
            loadPatients();
            renderPatients();
            updateStats();
            setInterval(checkOverduePatients, 60000); // Revisar cada minuto
            updateConnectionStatus();
        }

        // Cargar pacientes del localStorage
        function loadPatients() {
            const stored = localStorage.getItem('dengue_patients');
            if (stored) {
                patients = JSON.parse(stored);
                // Limpiar pacientes con más de 48 horas
                cleanOldPatients();
            }
        }

        // Guardar pacientes en localStorage
        function savePatients() {
            localStorage.setItem('dengue_patients', JSON.stringify(patients));
        }

        // Limpiar pacientes con más de 48 horas sin actualización
        function cleanOldPatients() {
            const now = new Date().getTime();
            const hours48 = 48 * 60 * 60 * 1000;
            patients = patients.filter(p => {
                const lastUpdate = new Date(p.lastCheck || p.createdAt).getTime();
                return (now - lastUpdate) < hours48;
            });
            savePatients();
        }

        // Cambiar de tab
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('patientsTab').style.display = tab === 'patients' ? 'block' : 'none';
            document.getElementById('statsTab').style.display = tab === 'stats' ? 'block' : 'none';

            if (tab === 'stats') {
                renderStats();
            }
        }

        // Abrir modal de nuevo paciente
        function openNewPatientModal() {
            document.getElementById('newPatientModal').classList.add('show');
        }

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Guardar nuevo paciente
        function saveNewPatient(event) {
            event.preventDefault();
            
            const patient = {
                id: Date.now().toString(),
                name: document.getElementById('patientName').value,
                age: document.getElementById('patientAge').value,
                sex: document.getElementById('patientSex').value,
                bed: document.getElementById('patientBed').value || 'N/A',
                monitoringInterval: parseInt(document.getElementById('monitoringInterval').value),
                createdAt: new Date().toISOString(),
                lastCheck: null,
                checks: [],
                initialNotes: document.getElementById('initialNotes').value,
                hasAlerts: false
            };

            patients.push(patient);
            savePatients();
            renderPatients();
            updateStats();
            
            // Limpiar formulario y cerrar modal
            document.getElementById('newPatientForm').reset();
            closeModal('newPatientModal');
        }

        // Renderizar lista de pacientes
        function renderPatients() {
            const grid = document.getElementById('patientGrid');
            const emptyState = document.getElementById('emptyState');

            if (patients.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = patients.map(p => {
                const timeSinceCheck = getTimeSinceLastCheck(p);
                const isOverdue = timeSinceCheck.isOverdue;
                const timeBadge = getTimeBadge(timeSinceCheck.hours, p.monitoringInterval);

                return `
                    <div class="patient-card ${p.hasAlerts ? 'alert' : ''}">
                        <div class="patient-header">
                            <div>
                                <div class="patient-name">${p.name}</div>
                                <div class="patient-id">ID: ${p.id} | Cama: ${p.bed}</div>
                            </div>
                            ${p.hasAlerts ? '<span class="alert-badge">⚠️ ALERTA</span>' : ''}
                        </div>
                        
                        <div class="patient-info">
                            <div class="info-row">
                                <span class="info-label">Edad:</span>
                                <span class="info-value">${p.age} años</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Sexo:</span>
                                <span class="info-value">${p.sex === 'M' ? 'Masculino' : 'Femenino'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Monitoreo:</span>
                                <span class="info-value">Cada ${p.monitoringInterval}h</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Chequeos:</span>
                                <span class="info-value">${p.checks.length}</span>
                            </div>
                        </div>

                        <div class="last-check ${isOverdue ? 'overdue' : ''}">
                            ${p.lastCheck 
                                ? `⏱️ Último chequeo: ${timeSinceCheck.text} ${timeBadge}`
                                : '⚠️ Sin chequeos registrados'}
                        </div>

                        <div class="patient-actions">
                            <button class="btn btn-primary btn-small" onclick="openCheckModal('${p.id}')">
                                ✅ Chequear
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="viewHistory('${p.id}')">
                                📋 Historia
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="deletePatient('${p.id}')">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Obtener tiempo desde el último chequeo
        function getTimeSinceLastCheck(patient) {
            if (!patient.lastCheck) {
                return { text: 'Nunca', hours: 999, isOverdue: true };
            }

            const now = new Date();
            const lastCheck = new Date(patient.lastCheck);
            const diffMs = now - lastCheck;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

            const isOverdue = diffHours >= patient.monitoringInterval;

            let text;
            if (diffHours === 0) {
                text = `hace ${diffMins} min`;
            } else {
                text = `hace ${diffHours}h ${diffMins}min`;
            }

            return { text, hours: diffHours, isOverdue };
        }

        // Obtener badge de tiempo
        function getTimeBadge(hours, interval) {
            if (hours < interval * 0.8) {
                return '<span class="time-badge good">✓ Al día</span>';
            } else if (hours < interval) {
                return '<span class="time-badge warning">⚠ Próximo</span>';
            } else {
                return '<span class="time-badge danger">⚠ Vencido</span>';
            }
        }

        // Abrir modal de chequeo
        function openCheckModal(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            document.getElementById('checkPatientName').textContent = 
                `${patient.name} - ${patient.bed}`;
            
            // Limpiar checkboxes y notas
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`sign${i}`).checked = false;
            }
            document.getElementById('checkNotes').value = '';
            
            document.getElementById('checkSignsModal').classList.add('show');
        }

        // Guardar chequeo
        function saveCheck() {
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;

            // Recopilar signos de alarma seleccionados
            const signs = [];
            for (let i = 1; i <= 8; i++) {
                const checkbox = document.getElementById(`sign${i}`);
                if (checkbox.checked) {
                    signs.push(checkbox.value);
                }
            }

            const notes = document.getElementById('checkNotes').value;

            const check = {
                timestamp: new Date().toISOString(),
                signs: signs,
                notes: notes,
                hasAlerts: signs.length > 0
            };

            patient.checks.push(check);
            patient.lastCheck = check.timestamp;
            patient.hasAlerts = signs.length > 0;

            savePatients();
            renderPatients();
            updateStats();
            closeModal('checkSignsModal');
        }

        // Ver historia del paciente
        function viewHistory(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            currentPatientId = patientId;
            document.getElementById('historyPatientName').textContent = 
                `${patient.name} - ${patient.bed}`;

            const historyContent = document.getElementById('historyContent');
            
            if (patient.checks.length === 0) {
                historyContent.innerHTML = '<p style="text-align: center; color: #9ca3af;">No hay chequeos registrados</p>';
            } else {
                historyContent.innerHTML = patient.checks
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .map(check => {
                        const date = new Date(check.timestamp);
                        return `
                            <div class="history-item">
                                <div class="history-time">
                                    📅 ${date.toLocaleDateString('es-ES')} - 
                                    🕐 ${date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                                ${check.signs.length > 0 ? `
                                    <div class="history-signs">
                                        <strong>⚠️ Signos de alarma:</strong><br>
                                        ${check.signs.map(s => `• ${s}`).join('<br>')}
                                    </div>
                                ` : '<div class="history-signs">✅ Sin signos de alarma</div>'}
                                ${check.notes ? `
                                    <div class="history-notes">
                                        📝 ${check.notes}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
            }

            document.getElementById('historyModal').classList.add('show');
        }

        // Generar informe del paciente
        function generateReport() {
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;

            let report = `INFORME DE MONITOREO - DENGUE CON SIGNOS DE ALARMA\n`;
            report += `=================================================\n\n`;
            report += `DATOS DEL PACIENTE:\n`;
            report += `Nombre: ${patient.name}\n`;
            report += `Edad: ${patient.age} años\n`;
            report += `Sexo: ${patient.sex === 'M' ? 'Masculino' : 'Femenino'}\n`;
            report += `Cama/Historia: ${patient.bed}\n`;
            report += `Intervalo de monitoreo: Cada ${patient.monitoringInterval} hora(s)\n`;
            report += `Fecha de ingreso: ${new Date(patient.createdAt).toLocaleString('es-ES')}\n\n`;
            
            if (patient.initialNotes) {
                report += `OBSERVACIONES INICIALES:\n${patient.initialNotes}\n\n`;
            }

            report += `REGISTRO DE CHEQUEOS (${patient.checks.length} total):\n`;
            report += `-----------------------------------\n\n`;

            patient.checks.forEach((check, index) => {
                const date = new Date(check.timestamp);
                report += `[${index + 1}] ${date.toLocaleString('es-ES')}\n`;
                
                if (check.signs.length > 0) {
                    report += `⚠️ SIGNOS DE ALARMA DETECTADOS:\n`;
                    check.signs.forEach(sign => {
                        report += `  • ${sign}\n`;
                    });
                } else {
                    report += `✅ Sin signos de alarma\n`;
                }
                
                if (check.notes) {
                    report += `📝 Notas: ${check.notes}\n`;
                }
                report += `\n`;
            });

            // Resumen de signos de alarma
            const allSigns = patient.checks.flatMap(c => c.signs);
            const signCounts = {};
            allSigns.forEach(sign => {
                signCounts[sign] = (signCounts[sign] || 0) + 1;
            });

            if (Object.keys(signCounts).length > 0) {
                report += `\nRESUMEN DE SIGNOS DE ALARMA:\n`;
                report += `-----------------------------------\n`;
                Object.entries(signCounts)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([sign, count]) => {
                        report += `• ${sign}: ${count} vez/veces\n`;
                    });
            }

            report += `\n\nInforme generado: ${new Date().toLocaleString('es-ES')}\n`;

            // Descargar como archivo
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Informe_${patient.name.replace(/\s/g, '_')}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Eliminar paciente
        function deletePatient(patientId) {
            if (!confirm('¿Está seguro de eliminar este paciente? Esta acción no se puede deshacer.')) {
                return;
            }

            patients = patients.filter(p => p.id !== patientId);
            savePatients();
            renderPatients();
            updateStats();
        }

        // Actualizar estadísticas
        function updateStats() {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const withAlerts = patients.filter(p => p.hasAlerts).length;
            document.getElementById('patientsWithAlerts').textContent = withAlerts;
            document.getElementById('totalAlertsCount').textContent = withAlerts;

            const overdue = patients.filter(p => {
                const time = getTimeSinceLastCheck(p);
                return time.isOverdue;
            }).length;
            document.getElementById('overdueChecks').textContent = overdue;
        }

        // Renderizar estadísticas detalladas
        function renderStats() {
            const statsContent = document.getElementById('statsContent');
            
            // Contar todos los signos de alarma
            const allSigns = patients.flatMap(p => p.checks.flatMap(c => c.signs));
            const signCounts = {};
            
            allSigns.forEach(sign => {
                signCounts[sign] = (signCounts[sign] || 0) + 1;
            });

            if (Object.keys(signCounts).length === 0) {
                statsContent.innerHTML = '<p style="text-align: center; color: #9ca3af;">No hay datos suficientes para mostrar estadísticas</p>';
                return;
            }

            const sorted = Object.entries(signCounts).sort((a, b) => b[1] - a[1]);
            const maxCount = sorted[0][1];

            statsContent.innerHTML = `
                <div class="stats-grid">
                    ${sorted.map(([sign, count]) => {
                        const percentage = (count / maxCount) * 100;
                        return `
                            <div class="stat-card">
                                <div class="stat-value">${count}</div>
                                <div class="stat-label">${sign}</div>
                                <div style="margin-top: 10px; height: 8px; background: #fee2e2; border-radius: 4px;">
                                    <div style="width: ${percentage}%; height: 100%; background: #dc2626; border-radius: 4px;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Verificar chequeos vencidos
        function checkOverduePatients() {
            renderPatients();
            updateStats();
        }

        // Exportar todos los datos
        function exportAllData() {
            const data = {
                exportDate: new Date().toISOString(),
                totalPatients: patients.length,
                patients: patients
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dengue_Monitor_Export_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Actualizar estado de conexión
        function updateConnectionStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!navigator.onLine) {
                indicator.classList.add('offline');
            } else {
                indicator.classList.remove('offline');
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Iniciar la aplicación cuando se carga la página
        window.addEventListener('DOMContentLoaded', init);

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker-dengue.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Error al registrar Service Worker:', err));
            });
        }
    </script>
</body>
</html>
